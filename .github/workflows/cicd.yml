name: CI/CD Flask Pipeline

on:
  pull_request:
    branches: [ "dev", "master" ]
  push:
    branches: [ "dev", "master" ]

jobs:
  # JOB 1: CI (Linting/Checking) - Runs on PR and Push
  ci-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Linting Tools
        run: pip install flask

      - name: Syntax Check
        run: python -m py_compile app.py

  # JOB 2: CD (Deployment) - ONLY runs on Push/Merge to dev or master
  deploy:
    needs: ci-check
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Navigate to project folder
            cd /home/${{ secrets.EC2_USER }}/flask-cicd-project
            
            # Reset any local changes and pull latest code
            git fetch --all
            git reset --hard origin/${{ github.ref_name }}

            # Setup environment variables based on branch
            if [ "${{ github.ref_name }}" == "master" ]; then
              export APP_PORT=5000
              export APP_ENV=live
            else
              export APP_PORT=4000
              export APP_ENV=dev
            fi

            # Install dependencies in the virtual environment
            ./venv/bin/pip install -r requirements.txt

            # Stop existing app on the target port
            sudo fuser -k $APP_PORT/tcp || true

            # START APP IN BACKGROUND (The fix for Status 143)
            # We use < /dev/null to prevent the SSH session from hanging
            nohup ./venv/bin/python app.py > app.log 2>&1 < /dev/null &
            
            # Give the app a moment to start before closing connection
            sleep 2
            
            # Verify if it's running
            ps aux | grep "python app.py" | grep $APP_PORT || echo "App failed to start"
